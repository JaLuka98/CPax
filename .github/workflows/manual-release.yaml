name: Manual CalVer Release

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry-run only? (no commit, no push)'
        type: boolean
        default: true

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          tags: true

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install bump-my-version
        run: pip install bump-my-version

      - name: Compute & (dry-)apply CalVer bump
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          YEAR=$(date +%Y)
          MONTH=$(date +%m)
          PREFIX="v${YEAR}.${MONTH}"
          LATEST=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [[ "$LATEST" == $PREFIX.* ]]; then
            SEQ=${LATEST##*.}
            NEXT_SEQ=$((SEQ + 1))
          else
            NEXT_SEQ=0
          fi
          NEW_VERSION="${YEAR}.${MONTH}.${NEXT_SEQ}"
          echo "â†’ Next version will be ${NEW_VERSION}"

          CMD="bump-my-version set ${NEW_VERSION}"
          if [[ "$DRY_RUN" == 'true' ]]; then
            CMD+=" --dry-run --verbose"
          fi
          echo "Running: $CMD"
          $CMD

      - name: Push changes
        if: ${{ github.event.inputs.dry_run == false }}
        run: git push origin HEAD --follow-tags
